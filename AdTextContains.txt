var SPREAD_SHEET = "https://docs.google.com/spreadsheets/d/1KlfOtYepVKc-PGLfChaydK9owWVdipYGtv2JgNJRJDE/edit#gid=0";
var SHEET_NAME = "Description";
var SHEET = SpreadsheetApp.openByUrl(SPREAD_SHEET).getSheetByName(SHEET_NAME);
var COLTITLECOLOUR = "#DCDCDC"
var WHITE = "#FFF"

function main(){
  
//  checkAdvertText();
  
  var accounts = MccApp
  .accounts()
  .executeInParallel("checkAdvertText", "doAfter");
  
}


function checkAdvertText(){
  
  var account = AdWordsApp.currentAccount(); 
  var accountName = account.getName();
  var accountID = account.getCustomerId();
  
  var advertSelector = AdWordsApp
  .ads()
  .withCondition("Type = EXPANDED_TEXT_AD AND CampaignStatus = ENABLED AND AdGroupStatus = ENABLED AND Status = ENABLED AND Description CONTAINS_IGNORE_CASE 'Today'");
  
  var advertArray = new Array();
    
  var advertIterator = advertSelector.get();
  
  while(advertIterator.hasNext()){
    var advert = advertIterator.next().asType().expandedTextAd();
    var campaign = advert.getCampaign().getName();
    var adGroup = advert.getAdGroup().getName();
    var headline1 = advert.getHeadlinePart1();
    var headline2 = advert.getHeadlinePart2();
    var description = advert.getDescription(); 
    var type = advert.getType();
    var id = advert.getId();
    
    advertArray.push([accountName, campaign, adGroup, headline1, headline2, description, id, type]);   
  }  
  
  
  jsonObj = {
    'data': advertArray 
  }
  
  return JSON.stringify(jsonObj);
}

function doAfter(results){
  
  var data = [];
  var allAdverts = [];
  
  for (var i = 0; i < results.length; i++) {
    var result = results[i].getReturnValue();
    var resultObj = JSON.parse(result);
    
    var adverts = resultObj['data'];
    
    for (var x in adverts) {
      allAdverts.push(adverts[x]); 
    }
  }
  
  var headers = ["AccountName", "CampaignName", "AdGroupName", "Headline1", "Headline2", "Description", "ID", "Type"]; 
  SHEET.getRange(1, 1, 1, headers.length).setValues([headers]).setBackground(COLTITLECOLOUR).setFontWeight("BOLD");
  
  var lastRow = SHEET.getLastRow() + 1;
  
  SHEET.getRange(lastRow, 1, allAdverts.length, headers.length).setValues(allAdverts).setBackground(WHITE).setFontWeight("NORMAL");
 
}


