/********
*
* Check Ad Status
* This script will email recipients Disapproved Adverts for
* Enabled Campaigns and enabled Ad Groups.
* This script can run hourly if required.
* Advise running daily as it may result in exceeding email quota.
* Version: 1.02
* Date: 30/08/2017
* Author: Nicholas Potts
* On behalf of bet365.com.
*
********/

function main() {
  var recipients = ("Nicholas.Potts@bet365.com, Christopher.Taylor@bet365.com");
  
  var accountName = AdWordsApp.currentAccount().getName();
  var accountID = AdWordsApp.currentAccount().getCustomerId();
  var emailQuotaRemaining = MailApp.getRemainingDailyQuota();
  
  var arr = [];
  var arr1 = [];
  
  var emailHeader = ["Customer ID", "Account Name", "Campaign Name", "AdGroup Name", "Advert ID", "Ad Policy Approval Status", "Ad Approval Status", "Ad Enabled"];
  
  var adSelector = AdWordsApp
  .ads()
  .withCondition("CampaignStatus = ENABLED AND AdGroupStatus = ENABLED AND ApprovalStatus = DISAPPROVED");
  
  var adIterator = adSelector.get();
  while (adIterator.hasNext()){
    var ad = adIterator.next();
    var campaignName = ad.getCampaign().getName();
    var adGroupName = ad.getAdGroup().getName();
    var advertID = ad.getId().toString();
    var adPolicyApprovalStatus = ad.getPolicyApprovalStatus();
    var approvalStatus = ad.getApprovalStatus();
    var advertStatus = ad.isEnabled().toString().toUpperCase();
    arr = [accountID, accountName, campaignName, adGroupName, advertID, adPolicyApprovalStatus, approvalStatus, advertStatus];
    arr1.push('<tr class="tableRowBold">');
    arr1.push('<td>'+arr.join('</td><td>')+'</td>');
    arr1.push('</tr>'); 
  }
  
  if (arr.length.toFixed() >= 1 && arr.length.toFixed() < 500) {
    var html = [];
    html.push('<html><head><style>',
              '.tableRowBold {font-weight: normal; font: 10pt arial; padding: 3px 3px 3px 3px; background-color: #fffff; border: 1px solid black}',
              '.tableColor {font: 10pt arial; padding: 3px 3px 3px 3px; background-color: #fffff; border: 1px solid black}',
              'th {font: 12pt arial; text-align: left; border: 1px solid black; background-color: #ddd; padding: 2px 2px 2px 2px}',
              'td {text-align: left; border: 1px solid black}',
              'span {font: 14pt arial;}',
              'p {font: 10pt arial;}',
              '</style></head>',
              '<body>',
              '<table><tr><th>', emailHeader.join('</th><th>'), arr1.join(''), '</table>',
              '<p><STRONG>Remaining Email Quota: ', emailQuotaRemaining, '</STRONG></p>',
              '</body>',
              '</html>'
             );       
    
    MailApp.sendEmail({
      to: recipients,
      name: 'Ad Approval Status',
      subject: accountName + ' | Ad Approval Status',
      htmlBody: html.join('\n'),
    });
    Logger.log("Email Sent: " + Utilities.formatDate(new Date(), AdWordsApp.currentAccount().getTimeZone(), 'MMMM dd, yyyy HH:mm:ss Z'));
  } else if (arr.length.toFixed() > 500) { 
    MailApp.sendEmail({
      to: recipients,
      name: 'Ad Approval Status - Error',
      subject: accountName + ' | Ad Approval Status - Error',
      htmlBody: "Email Failed to Send. Over 500 Disapproved Adverts",
    });
    Logger.log("Email Failed to Send. Over 500 Disapproved Adverts: " + Utilities.formatDate(new Date(), AdWordsApp.currentAccount().getTimeZone(), 'MMMM dd, yyyy HH:mm:ss Z'));    
  }
  else {
    Logger.log("No Disapproved Adverts in " + accountName + "in Active Campaigns and Active Ad Groups: " + Utilities.formatDate(new Date(), AdWordsApp.currentAccount().getTimeZone(), 'MMMM dd, yyyy HH:mm:ss Z'));
  }
}
