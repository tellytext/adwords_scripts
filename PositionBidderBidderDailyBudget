/********
*
* Position Bidder
* Specify Campaigns
* Version: 1.02
* Date: 30/08/2017
* Author: Nicholas Potts
* On behalf of bet365.com.
*
********/

function main() {
  
  var primaryCampaign = "(N) 0001 *Brand* - UK - Exact"
  var secondaryCampaign = "(N) 0005 *Brand* Position 2 - UK - Exact"
  var now = getDateInTheAccountTimezone();
  var nowhour = now.toString().substring(09,11);
  var lasthour = nowhour-1;
  var bidArray = {};
  
  Logger.log("Date: " + now + " Hour: " + lasthour);
  
  var report = AdWordsApp.report("SELECT AdGroupName, Device, HourOfDay, Clicks, Cost " +
                                 "FROM ADGROUP_PERFORMANCE_REPORT " +
                                 "WHERE CampaignName = '" + primaryCampaign + "' " +              
                                 "DURING TODAY " );
  
  var rows = report.rows();
  
  while (rows.hasNext()) {
    var row = rows.next();
    var adgroup = row['AdGroupName'];
    var HourOfDay = row['HourOfDay'];
    var clicks = row['Clicks'];
    var cost = row['Cost'];
    var device = row['Device'];
    var HourOfDay = HourOfDay.toString();
    var costfloat = toFloat(cost);
    
    if (lasthour == HourOfDay ){
      var agObj = bidArray[adgroup] || {};
      agObj[device] = toFloat(costfloat/clicks);
      bidArray[adgroup] = agObj;
    }
  }
  
  Logger.log(bidArray);
  
  var r2campaign = AdWordsApp.campaigns().withCondition("Name = '"+ secondaryCampaign + "'").get().next();
  var r2adgroups = r2campaign.adGroups().get();
  while (r2adgroups.hasNext()){
    var r2adgroup = r2adgroups.next();
    var dev = bidArray[r2adgroup.getName()] || {};
    var newbidcomp = dev['Computers'] || -1;
    var newbidmob = dev['Mobile devices with full browsers'] || -1;
    
    if (newbidcomp != -1) {
      
      r2adgroup.bidding().setCpc(newbidcomp * 0.90 );
      Logger.log("Set campaign - "+ r2campaign.getName() + " - adgroup - " + r2adgroup.getName() + " max cpc as - " + newbidcomp* 0.90);
    }
    
    if (newbidmob != -1) {
      
      r2adgroup.setMobileBidModifier(((newbidmob * 1.05) / newbidcomp));
      Logger.log("Set campaign - "+ r2campaign.getName() + " - adgroup - " + r2adgroup.getName() + " mob modifier as - " + ((newbidmob* 1.05) / newbidcomp));
    }
  }
}


function getDateInTheAccountTimezone() {
  var date = new Date();
  var timeZone = AdWordsApp.currentAccount().getTimeZone();
  date = Utilities.formatDate(date, "Europe/London", 'dd/MM/yy HH:mm:ss Z');
  return date;
}
function toFloat(value){
  value = value.toString().replace(/,/g, '');
  return parseFloat(value).toFixed(2);
}
