/********
*
* Checks Brand Average Position 
* This script will email recipients keywords which have an average position lower than 1.2.
* Script runs weekly.
* Date: 21/02/2018
* Author: Mark Trapani
* On behalf of bet365.com.
*
********/

var emails = "mark.trapani@bet365.com, Nicholas.Potts@bet365.com, Christopher.Taylor@bet365.com, Ulrik.Haack-Pedersen@bet365.com, Laura.Fernandez@bet365.com, Diego.Lavatelli@bet365.com, Lauren.Farrell@bet365.com, Luke.Anderson@bet365.com";
var tableHeaders = ["Account Name","Campaign Name", "AdGroup Name", "Keyword", "Impressions", "Avg. CPC", "Max. CPC", "Average Position (Data based on last 7 days)"];

function main() {
  
  var accounts = MccApp
  .accounts()
  .forDateRange("LAST_7_DAYS")
  .withCondition("Cost > 10")
  .executeInParallel("getKeywordsPosition", "doThisAfter");
  
}


function getKeywordsPosition() {
  
  var arr = [];
  var arr1 = [];
  
 
  var keywordSelector = AdWordsApp.keywords()
  .forDateRange("LAST_7_DAYS")
  .withCondition("AveragePosition > 1.2")
  .withCondition("CampaignName CONTAINS_IGNORE_CASE 'brand'")
  .withCondition("CampaignName DOES_NOT_CONTAIN_IGNORE_CASE 'pure'")
  .withCondition("Text CONTAINS '3'");

  
  var keywordIterator = keywordSelector.get();
  
  while (keywordIterator.hasNext()) {
    var keyword = keywordIterator.next();
    var campaignName = keyword.getCampaign().getName();
    var adGroupName = keyword.getAdGroup().getName();
    var avgPos = keyword.getStatsFor("LAST_7_DAYS").getAveragePosition();
    var impressions = keyword.getStatsFor("LAST_7_DAYS").getImpressions();
    var cpc = Math.round((keyword.getStatsFor("LAST_7_DAYS").getAverageCpc())*100) / 100;
    var bids = keyword.bidding().getCpc();
    
    arr = [AdWordsApp.currentAccount().getName(),campaignName,adGroupName,keyword.getText(), impressions, '£' +cpc, '£' +bids, avgPos];  
    
//    arr1.push('<tr class="tableRowBold">');
//    arr1.push('<td>'+arr.join('</td><td>')+'</td>');
//    arr1.push('</tr>');
    
    arr1.push(arr);
  }

  jsonObj = {
    'data': arr1
  }
  
  return JSON.stringify(jsonObj);  
}


function doThisAfter(results) {
  
  var html = [];
  var allKeywords = [];
  
  for (var i = 0; i < results.length; i++) {
    var result = results[i].getReturnValue();
    var resultObj = JSON.parse(result);
    
    var keywords = resultObj['data'];
    
    for (var x in keywords) {
      allKeywords.push(keywords[x]);
    }
  }
  sendEmail(emails, tableHeaders, allKeywords);
}

function sendEmail(emails, tableHeaders, tableData) {
  
  var tableRowHTML = [];
  
  for (var x in tableData) {
    tableRowHTML.push('<tr class="tableRowBold">');
    tableRowHTML.push('<td>'+tableData[x].join('</td><td>')+'</td>');
    tableRowHTML.push('</tr>');
  }
  
  if(tableData.length < 1) {
    throw "Nothing to send"
  }
  
  var html = [];
  html.push('<html><head><style>',
            '.tableRowBold {font-weight: normal; font: 10pt arial; padding: 3px 3px 3px 3px; background-color: #fffff; border: 1px solid black}',
            '.tableColor {font: 10pt arial; padding: 3px 3px 3px 3px; background-color: #fffff; border: 1px solid black}',
            'th {font: 12pt arial; text-align: left; border: 1px solid black; background-color: #ddd; padding: 2px 2px 2px 2px}',
            'td {text-align: left; border: 1px solid black}',
            'span {font: 14pt arial;}',
            'p {font: 10pt arial;}',
            '</style></head>',
            '<body>',
            '<table><tr><th>', tableHeaders.join('</th><th>'), tableRowHTML.join(''), '</table>',
            '</body>',
            '</html>'
           );
  
  try {
    MailApp.sendEmail({
      to: emails,
      name: 'Brand KWs Avg. Position',
      subject: tableData.length + ' low ranked keywords found. Emails: ' + MailApp.getRemainingDailyQuota(),
      htmlBody: html.join('\n'),
    });
    Logger.log("Email Sent: " + Utilities.formatDate(new Date(), AdWordsApp.currentAccount().getTimeZone(), 'MMMM dd, yyyy HH:mm:ss Z'));
  }
  catch (e) {
    Logger.log(e)
    MailApp.sendEmail({
      to: emails,
      name: 'ERROR',
      subject: tableData.length + ' low ranked keywords found. Emails: ' + MailApp.getRemainingDailyQuota(),
      htmlBody: e,
    });
    Logger.log("Email did not send: " + Utilities.formatDate(new Date(), AdWordsApp.currentAccount().getTimeZone(), 'MMMM dd, yyyy HH:mm:ss Z'));
  }
  
}

